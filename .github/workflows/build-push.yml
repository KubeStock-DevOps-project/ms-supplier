# =============================================================================
# KubeStock - ms-supplier Service
# CI/CD Pipeline: Build, Push & Deploy to Staging
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: ms-supplier
  NODE_VERSION: '18'
  GITOPS_REPO: KubeStock-DevOps-project/kubestock-gitops
  SERVICE_NAME: ms-supplier

permissions:
  id-token: write
  contents: read

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: BUILD & PUSH TO ECR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest

    outputs:
      image_uri: ${{ steps.build-push.outputs.image_uri }}
      image_tag: ${{ steps.build-push.outputs.image_tag }}
      short_sha: ${{ steps.meta.outputs.short_sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build and Push Docker image
        id: build-push
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          IMAGE_URI="${REGISTRY}/${{ env.ECR_REPOSITORY }}"
          
          docker build \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg VERSION=${{ github.ref_name }} \
            -t ${IMAGE_URI}:${{ steps.meta.outputs.full_sha }} \
            -t ${IMAGE_URI}:${{ steps.meta.outputs.short_sha }} \
            -t ${IMAGE_URI}:${{ steps.meta.outputs.timestamp }} \
            -t ${IMAGE_URI}:latest \
            .
          
          docker push ${IMAGE_URI}:${{ steps.meta.outputs.full_sha }}
          docker push ${IMAGE_URI}:${{ steps.meta.outputs.short_sha }}
          docker push ${IMAGE_URI}:${{ steps.meta.outputs.timestamp }}
          docker push ${IMAGE_URI}:latest
          
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ steps.meta.outputs.short_sha }}" >> $GITHUB_OUTPUT

      - name: Build summary
        run: |
          echo "## ðŸš€ Build & Push Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | \`${{ env.ECR_REPOSITORY }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA Tag** | \`${{ steps.meta.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Full SHA** | \`${{ steps.meta.outputs.full_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | \`${{ steps.meta.outputs.timestamp }}\` |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: UPDATE GITOPS REPO FOR STAGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-gitops:
    name: Update GitOps (Staging)
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          ref: main

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update staging image tag
        run: |
          cd overlays/staging
          
          # Update image tag to specific SHA
          kustomize edit set image \
            478468757808.dkr.ecr.ap-south-1.amazonaws.com/${{ env.SERVICE_NAME }}=478468757808.dkr.ecr.ap-south-1.amazonaws.com/${{ env.SERVICE_NAME }}:${{ needs.build-and-push.outputs.short_sha }}
          
          echo "Updated ${{ env.SERVICE_NAME }} to tag: ${{ needs.build-and-push.outputs.short_sha }}"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add overlays/staging/kustomization.yaml
          
          git commit -m "chore(${{ env.SERVICE_NAME }}): deploy ${{ needs.build-and-push.outputs.short_sha }} to staging
          
          Service: ${{ env.SERVICE_NAME }}
          Image Tag: ${{ needs.build-and-push.outputs.short_sha }}
          Commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}"
          
          git push origin main

      - name: Summary
        run: |
          echo "## ðŸ“ GitOps Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically sync the new image" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${{ needs.build-and-push.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: STAGING APPROVAL GATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  staging-approval:
    name: Approve Staging Deployment
    runs-on: ubuntu-latest
    needs: [build-and-push, update-gitops]
    environment: staging
    
    steps:
      - name: Waiting for approval
        run: |
          echo "## â³ Awaiting Staging Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Manual approval required to proceed" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${{ needs.build-and-push.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: VERIFY STAGING DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: Verify Staging Deployment
    runs-on: ubuntu-latest
    needs: [build-and-push, update-gitops, staging-approval]
    environment: staging
    
    steps:
      - name: Deployment verification
        run: |
          echo "ðŸš€ Deploying ${{ env.SERVICE_NAME }} to staging"
          echo "Image: ${{ needs.build-and-push.outputs.image_uri }}:${{ needs.build-and-push.outputs.short_sha }}"
          echo ""
          echo "ArgoCD will automatically:"
          echo "  âœ“ Detect GitOps repo changes"
          echo "  âœ“ Sync deployment with new image"
          echo "  âœ“ Wait for rollout completion"
          echo "  âœ“ Perform health checks"
          echo "  âœ“ Self-heal if needed"
          
      - name: Deployment summary
        run: |
          echo "## âœ… Staging Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | \`${{ env.SERVICE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`staging\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.build-and-push.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed By** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Status" >> $GITHUB_STEP_SUMMARY
          echo "Check: https://argocd.yourdomain.com/applications/kubestock-staging" >> $GITHUB_STEP_SUMMARY
